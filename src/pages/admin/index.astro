---
// src/pages/admin/rooms/index.astro
import SectionContainer from "@/components/SectionContainer.astro"
import LayoutAdmin from "@/layouts/LayoutAdmin.astro"
import { supabase } from "@/db/supabase"

// Verificar sesión existente
const {
	data: { session },
} = await supabase.auth.getSession()

// Redirigir si ya está autenticado
if (session) {
	return Astro.redirect("/admin/dashboard")
}

// Manejar el envío del formulario
let errorMessage = null

if (Astro.request.method === "POST") {
	try {
		const formData = await Astro.request.formData()
		const email = formData.get("email")?.toString() || ""
		const password = formData.get("password")?.toString() || ""

		const { error } = await supabase.auth.signInWithPassword({
			email,
			password,
		})

		if (error) {
			errorMessage = error.message
		} else {
			return Astro.redirect("/admin/dashboard")
		}
	} catch (err) {
		errorMessage = "Error al procesar el formulario. Por favor intenta nuevamente."
		console.error("Error en login:", err)
	}
}
---

<LayoutAdmin title="RentRoomBcn - Admin Login">
	<main class="flex flex-grow items-center justify-center px-4 py-12 sm:px-6 lg:px-8">
		<div class="w-full max-w-md space-y-8 rounded-lg bg-white p-8 shadow-md">
			<div class="text-center">
				<h2 class="mt-6 text-3xl font-extrabold text-primary">Iniciar Sesión</h2>
				<p class="mt-2 text-sm text-secondary">Accede al panel de administración</p>
      </div>

			<form class="mt-8 space-y-6" method="POST">
				<div class="space-y-4 rounded-md shadow-sm">
					<div>
						<label for="email" class="block text-sm font-medium text-primary"> Email </label>
						<input
							id="email"
							name="email"
							autocomplete="email"
							required
							class="block w-full rounded-md border-0 px-3 py-2 text-primary placeholder-headerBg shadow-sm ring-1 ring-inset ring-secondary focus:ring-2 focus:ring-inset focus:ring-primary sm:text-sm"
							placeholder="Email"
						/>
      </div>

					<div>
						<label for="password" class="block text-sm font-medium text-primary">
							Contraseña
						</label>
						<input
							id="password"
							name="password"
							type="password"
							autocomplete="current-password"
							required
							class="block w-full rounded-md border-0 px-3 py-2 text-primary placeholder-headerBg shadow-sm ring-1 ring-inset ring-secondary focus:ring-2 focus:ring-inset focus:ring-primary sm:text-sm"
							placeholder="••••••••"
						/>
    </div>
					{
						errorMessage && (
							<div class="rounded-md bg-red-50 p-4">
								<p class="text-sm text-red-800">{errorMessage}</p>
							</div>
						)
					}
				</div>

				<div>
					<button
						type="submit"
						class="hover:bg-primaryDark flex w-full justify-center rounded-md bg-primary px-4 py-2 text-sm font-medium text-white shadow-sm focus:outline-none focus:ring-2 focus:ring-primary focus:ring-offset-2"
					>
						Entrar
					</button>
				</div>
			</form>
		</div>
	</main>
</LayoutAdmin>
