---
import PDPRoom from "@/components/PDPRoom.astro"
import SectionContainer from "@/components/SectionContainer.astro"
import i18next from "@/i18n/config.js"
import Layout from "@/layouts/Layout.astro"
import { supabase } from "@/db/supabase"

export const prerender = true

export async function getStaticPaths() {
	// Obtener todas las habitaciones desde Supabase
	const { data: rooms, error } = await supabase.from("rooms").select("slug")

	if (error) {
		console.error("Error fetching rooms:", error)
		return []
	}

	// Generate paths for both 'es' and 'en' languages for each room
	const paths = rooms.flatMap((room) => [
		{ params: { lang: "es", slug: room.slug } },
		{ params: { lang: "en", slug: room.slug } },
	])

	return paths
}

// Obtén el slug desde la URL
const { slug } = Astro.params

// Busca la habitación correspondiente al slug en Supabase
const { data: room, error } = await supabase.from("rooms").select("*").eq("slug", slug).single()

if (!room || error) {
	throw new Error(`No se encontró la habitación con el slug: ${slug}`)
}

const lang = Astro.url.pathname.split("/")[1] || "es"
const translations = i18next.getResourceBundle(lang, "translation")
const findRoom = translations.FindRoom
---

<Layout title={`RentRoomBcn - ${findRoom.find_room}`}>
	<SectionContainer class="px-0">
		<div class="mx-auto max-w-7xl px-6 lg:px-8">
			<PDPRoom room={room} />
		</div>
	</SectionContainer>
</Layout>
